#!/bin/sh

#-----------
# Variables
#-----------

DIR=`pwd`;

#-----------
# functions
#-----------

function compilePlugins() {
    listdir=`find . -type d`;
    echo "listdir = $listdir";
    for dir in $listdir; do
	cd $dir;
	if test "`ls *Plugin.c 2>/dev/null`" != ""; then
	    echo "plugin dans $dir !";      
	    # make -f $SICONOSPATH/share/SICONOS/MakefilePlugin plugin
	    make -f $SICONOSPATH/share/SICONOS/MakefilePluginSample plugin
	    if test "$LD_LIBRARY_PATH" = ""; then
		export LD_LIBRARY_PATH=$PWD;
	    else
		export LD_LIBRARY_PATH=$PWD:$LD_LIBRARY_PATH; 
	    fi;	  
	fi;
	cd $DIR;
    done;
    echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH";
}

function cleanAll() {
    listdir=`find . -type d`;
    echo "listdir = $listdir";
    for dir in $listdir; do
	cd $dir;
	make -f $SICONOSPATH/share/SICONOS/MakefilePluginSample clean	    
	cd $DIR;
    done;
}

function cartridge() {
    echo "";
    echo "+---- SICONOS ----+";
    echo "|                 |";
    echo "| (c) INRIA CNRS  |";
    echo "|                 |";
    echo "+-----------------+"; 
    echo "";
}

#------
# main
#------

cartridge;

# parameters and paths
if test "$SICONOSPATH" = ""; then
    echo "SICONOSPATH undefined. stop";
    exit 1;
fi;

export LD_LIBRARY_PATH=$SICONOSPATH/lib:$LD_LIBRARY_PATH; 

clean="false";
while getopts ch OPTION
  do
  case "$OPTION" in
      c) clean=true;;
      h) echo "Path to a sample source file : compiles, links and runs this sample";
	 echo "-c : cleans the current repertory (deletes binary files, etc.)";
	 echo "-h : prints this help and exits";
	 exit 0;
	 ;;
  esac
done

if "$clean" = "true"; then
    cleanAll;
    exit 0;
fi;


sample="false"
# test if there are one argument. if not, exit
if [ $# -gt 1 ]; then
    echo "$0 : Bad number of argument";
    sample="true";
    exit 1;
fi;
	
# test if command file exist. if not, exit
if [ ! -f $1 ]; then
    echo "$1 file not found.";
    sample="false"
    exit 1;
else
    sample="true"
fi;
    

# plugin compilation
compilePlugins;

if "$sample" = "true"; then
# sample compilation
    echo "dir of sample is `dirname $1`";
    DIR_SAMPLE=`dirname $1`;

    if [ ! -d $DIR_SAMPLE ]; then
	echo "the sample dir is not correct";
	exit 1;
    else
	cd $DIR_SAMPLE;
	make -f $SICONOSPATH/share/SICONOS/MakefilePluginSample OBJ=`basename $1` sample run
	cd $DIR;
    fi;
fi;

exit 0;
