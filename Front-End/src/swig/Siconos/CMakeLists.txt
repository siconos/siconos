SET_SOURCE_FILES_PROPERTIES(Numerics.i PROPERTIES CPLUSPLUS ON)
SET_SOURCE_FILES_PROPERTIES(Kernel.i PROPERTIES CPLUSPLUS ON)
SET_SOURCE_FILES_PROPERTIES(IO.i PROPERTIES CPLUSPLUS ON)


IF(WITH_FCLIB)
  SET(SWIG_DEFS "${SWIG_DEFS};-DWITH_FCLIB")
  SET_SOURCE_FILES_PROPERTIES(FCLib.i PROPERTIES CPLUSPLUS ON)
ENDIF()

IF(HAVE_SICONOS_IO)
  SET(SWIG_DEFS "${SWIG_DEFS};-DWITH_IO")
ENDIF()

SET_SOURCE_FILES_PROPERTIES(
  Numerics.i 
  Kernel.i 
  IO.i
  FCLib.i
  PROPERTIES SWIG_FLAGS "-dirprot;-I${CMAKE_SOURCE_DIR}/src/swig/Siconos;-Wall;${SWIG_DEFS}")

# cf LIBRARY_PROJECT_SETUP, but we do not use it here.

# do not skip the full RPATH for the build tree
SET(CMAKE_SKIP_BUILD_RPATH FALSE)

# when building, don't use the install RPATH already
# (but later on when installing)
SET(CMAKE_BUILD_WITH_INSTALL_RPATH FALSE) 

# the RPATH to be used when installing
ASSERT(CMAKE_INSTALL_LIBDIR)
SET(CMAKE_INSTALL_RPATH "${CMAKE_INSTALL_LIBDIR}")

# don't add the automatically determined parts of the RPATH
# which point to directories outside the build tree to the install RPATH
SET(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)

# doxygen documentation
#

#  http://www.swig.org/Doc2.0/SWIG.html
#  5.1.3 Comments
#  
#  C and C++ style comments may appear anywhere in interface files. In
#  previous versions of SWIG, comments were used to generate
#  documentation files. However, this feature is currently under repair
#  and will reappear in a later SWIG release.
#
#  This is a workaround:
FIND_PACKAGE(Doxygen REQUIRED)


# xml files generation

# find all siconos headers
FILE(GLOB _HDRS ${SiconosNumerics_INCLUDE_DIRS}/*.h)
FILE(GLOB _HPPDRS 
  ${SiconosKernel_INCLUDE_DIRS}/*.hpp 
  ${SiconosMechanics_INCLUDE_DIRS}/*.hpp 
  ${SiconosIO_INCLUDE_DIRS}/*.hpp)

SET(DOXYGEN_OUTPUT ${CMAKE_CURRENT_BINARY_DIR})

IF(DOXYGEN_FOUND)
  MESSAGE(STATUS "Found doxygen : configuring docstrings generation.")
  SET(XML_DOXY_CONFIG "${CMAKE_CURRENT_BINARY_DIR}/xml_doxy.config")

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/Moel_8hpp.xml) 
    CONFIGURE_FILE(xml_doxy.config.in ${CMAKE_CURRENT_BINARY_DIR}/xml_doxy.config)
    EXECUTE_PROCESS(COMMAND ${DOXYGEN_EXECUTABLE} ${XML_DOXY_CONFIG} WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR})
  ENDIF()

  # for each headers find associated xmls generated by doxygen
  FOREACH(_F ${_HDRS} ${_HPPDRS})
    GET_FILENAME_COMPONENT(_XFWE ${_F} NAME_WE)
    STRING(REPLACE "_" "__" _FWE ${_XFWE})
    FILE(GLOB ${_FWE}_XMLS  ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/*class${_FWE}.xml ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/*struct${_FWE}.xml ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/${_FWE}_8h*.xml)
    message(STATUS "For ${_XFWE} (translate to ${_FWE}) , xml files are : ${${_FWE}_XMLS}")
  ENDFOREACH(_F ${_HDRS1} ${_HPPDRS})

  SET(NUMERICS_DOCSTRINGS_FILES)
  FOREACH(_F ${_HDRS})
    GET_FILENAME_COMPONENT(_XFWE ${_F} NAME_WE)
    STRING(REPLACE "_" "__" _FWE ${_XFWE})
    FOREACH(_FXML ${${_FWE}_XMLS})
      GET_FILENAME_COMPONENT(_FWE_XML ${_FXML} NAME_WE)
      ADD_CUSTOM_COMMAND(OUTPUT ${_FWE_XML}.i 
        DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/${_FWE_XML}.xml
        COMMAND ${PYTHON_EXECUTABLE}
        ARGS "./doxy2swig.py" ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/${_FWE_XML}.xml ${_FWE_XML}.i
        COMMENT "docstrings generation for ${_FWE} (parsing ${_FWE_XML}.xml)")
      ADD_CUSTOM_TARGET(doc_${_FWE_XML}.i DEPENDS ${_FWE_XML}.i)
      LIST(APPEND NUMERICS_DOCSTRINGS_FILES ${_FWE_XML}.i)
    ENDFOREACH(_FXML ${${_FWE}_XMLS})
  ENDFOREACH(_F ${_HDRS})

  SET(KERNEL_DOCSTRINGS_FILES)
  FOREACH(_F ${_HPPDRS})
    GET_FILENAME_COMPONENT(_XFWE ${_F} NAME_WE)
    STRING(REPLACE "_" "__" _FWE ${_XFWE})
    FOREACH(_FXML ${${_FWE}_XMLS})
      GET_FILENAME_COMPONENT(_FWE_XML ${_FXML} NAME_WE)
      ADD_CUSTOM_COMMAND(OUTPUT ${_FWE_XML}.i 
        DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/${_FWE_XML}.xml
        COMMAND ${PYTHON_EXECUTABLE}
        ARGS "./doxy2swig.py" ${CMAKE_CURRENT_BINARY_DIR}/FrontEnd/xml/${_FWE_XML}.xml ${_FWE_XML}.i
        COMMENT "docstrings generation for ${_FWE} (parsing ${_FWE_XML}.xml)")
      ADD_CUSTOM_TARGET(doc_${_FWE_XML}.i DEPENDS ${_FWE_XML}.i)
      LIST(APPEND KERNEL_DOCSTRINGS_FILES ${_FWE_XML}.i)
    ENDFOREACH(_FXML ${${_FWE}_XMLS})
  ENDFOREACH(_F ${_HPPDRS})

  ADD_CUSTOM_COMMAND(OUTPUT Numerics-docstrings.i
    DEPENDS ${NUMERICS_DOCSTRINGS_FILES}
    COMMAND cat
    ARGS ${NUMERICS_DOCSTRINGS_FILES} > Numerics-docstrings.i
    COMMENT "Numerics docstrings concatenation")

  ADD_CUSTOM_COMMAND(OUTPUT Kernel-docstrings.i
    DEPENDS ${KERNEL_DOCSTRINGS_FILES}
    COMMAND cat
    ARGS ${KERNEL_DOCSTRINGS_FILES} > Kernel-docstrings.i
    COMMENT "Kernel docstrings concatenation")

  ADD_CUSTOM_TARGET(numerics_docstrings DEPENDS Numerics-docstrings.i)
  ADD_CUSTOM_TARGET(kernel_docstrings DEPENDS Kernel-docstrings.i)


  #
  # dependencies for generated sources
  #
  SET(SWIG_MODULE_Kernel_EXTRA_DEPS
    KernelTypes.i
    KernelRegistration.i
    solverOptions.i
    FrictionContactProblem.i
    handleException.i
    start.i
    end.i
    numpy.i
    pyRegister.i
    graph.i
    Kernel-docstrings.i)
  
  SET(SWIG_MODULE_Numerics_EXTRA_DEPS
    KernelTypes.i
    KernelRegistration.i
    solverOptions.i
    FrictionContactProblem.i
    start.i
    end.i
    numpy.i
    pyRegister.i
    Numerics-docstrings.i)
ENDIF()

  # WARNING ${swig_generated_file_fullname} is overriden 
# save it in a specific var if needed
SWIG_ADD_MODULE(Numerics python Numerics.i)
SET(Numerics_generated_file_fullname ${swig_generated_file_fullname})
MESSAGE(STATUS "Numerics generated files ${swig_generated_file_fullname}")

SWIG_ADD_MODULE(Kernel python Kernel.i)
SET(Kernel_generated_file_fullname ${swig_generated_file_fullname})
MESSAGE(STATUS "Kernel generated files ${swig_generated_file_fullname}")

IF(HAVE_SICONOS_IO)
  SWIG_ADD_MODULE(IO python IO.i)
  SET(IO_generated_file_fullname ${swig_generated_file_fullname})
  MESSAGE(STATUS "IO generated files ${swig_generated_file_fullname}")
  ADD_DEPENDENCIES(${SWIG_MODULE_IO_REAL_NAME} ${SWIG_MODULE_Kernel_REAL_NAME})
ENDIF()

IF(WITH_FCLIB)
  SWIG_ADD_MODULE(FCLib python FCLib.i)
  SET(FCLib_generated_file_fullname ${swig_generated_file_fullname})
  MESSAGE(STATUS "FCLib generated files ${swig_generated_file_fullname}")
ENDIF()

IF(HAVE_SICONOS_MECHANICS)
  SUBDIRS(Mechanics)
ENDIF()





#
# dependencies for libraries compilation
#
ADD_DEPENDENCIES(${SWIG_MODULE_Kernel_REAL_NAME} ${SWIG_MODULE_Numerics_REAL_NAME})

IF(DOXYGEN_FOUND)
  ADD_DEPENDENCIES(${SWIG_MODULE_Numerics_REAL_NAME} numerics_docstrings)
  ADD_DEPENDENCIES(${SWIG_MODULE_Kernel_REAL_NAME} kernel_docstrings)
ENDIF()

#
# Link
#

MESSAGE(STATUS "Link directories : ${${PROJECT_NAME}_LINK_DIRECTORIES}")
MESSAGE(STATUS "Link libraries : ${${PROJECT_NAME}_LINK_LIBRARIES}")

SWIG_LINK_LIBRARIES(Numerics ${PYTHON_LIBRARIES} 
  ${${PROJECT_NAME}_LINK_LIBRARIES}
  ${FORTRAN_LIBRARIES})

SWIG_LINK_LIBRARIES(Kernel ${PYTHON_LIBRARIES} 
  ${${PROJECT_NAME}_LINK_LIBRARIES})

IF(HAVE_SICONOS_IO)
  SWIG_LINK_LIBRARIES(IO ${PYTHON_LIBRARIES} 
    ${${PROJECT_NAME}_LINK_LIBRARIES})
ENDIF()

IF(WITH_FCLIB)
  SWIG_LINK_LIBRARIES(FCLib ${PYTHON_LIBRARIES} 
    ${${PROJECT_NAME}_LINK_LIBRARIES})
ENDIF()


# Generate plugins for tests here since if we put it in runtest.py,
# the siconos command is launched with the same directory multiple times
# and we then meet our dear friend "race condition"
IF(WITH_TESTING)
  IF(CMAKE_TOOLCHAIN_FILE)
    ADD_CUSTOM_COMMAND(TARGET ${SWIG_MODULE_Numerics_REAL_NAME}
      POST_BUILD
      COMMAND ${SiconosKernel_EXE_DIR}/siconos
      ARGS --noexec --generator="${CMAKE_GENERATOR}"
      ${CMAKE_CURRENT_SOURCE_DIR}/tests/test_xml.py
      -DCMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE}
      COMMENT "Generating plugins for tests")
  ELSE()
    ADD_CUSTOM_COMMAND(TARGET ${SWIG_MODULE_Numerics_REAL_NAME}
      POST_BUILD
      COMMAND ${SiconosKernel_EXE_DIR}/siconos
      ARGS --noexec --generator="${CMAKE_GENERATOR}"
      ${CMAKE_CURRENT_SOURCE_DIR}/tests/test_xml.py
      COMMENT "Generating plugins for tests")
  ENDIF()
ENDIF()


# get python dist-packages
# warning python may not know cmake_install_prefix
# installation in standard python dist package with:
# -DSTD_PYTHON_DIST_PACKAGES=TRUE 
#
# installation in specific place:
# -DPYTHON_DIST_PACKAGES=/my/specific/place

IF(STD_PYTHON_DIST_PACKAGES)
  EXECUTE_PROCESS ( COMMAND 
    ${PYTHON_EXECUTABLE} -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())"
    OUTPUT_VARIABLE PYTHON_DIST_PACKAGES 
    OUTPUT_STRIP_TRAILING_WHITESPACE)
ELSE(STD_PYTHON_DIST_PACKAGES)
  IF(NOT PYTHON_DIST_PACKAGES)
    EXECUTE_PROCESS ( COMMAND 
      ${PYTHON_EXECUTABLE} -c "from distutils.sysconfig import get_python_lib;print(get_python_lib(0,0,\"\"))"
      OUTPUT_VARIABLE PYTHON_DIST_PACKAGES 
      OUTPUT_STRIP_TRAILING_WHITESPACE)
  ENDIF(NOT PYTHON_DIST_PACKAGES)
ENDIF(STD_PYTHON_DIST_PACKAGES)

MESSAGE(STATUS "PYTHON_DIST_PACKAGES : ${PYTHON_DIST_PACKAGES}")

INSTALL(PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/Numerics.py 
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)

INSTALL(PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/Kernel.py 
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)

IF(HAVE_SICONOS_IO)
  INSTALL(PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/IO.py 
    DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)
ENDIF()

CONFIGURE_FILE(__init__.py.in ${CMAKE_CURRENT_BINARY_DIR}/__init__.py)

CONFIGURE_FILE(path.i.in ${CMAKE_CURRENT_BINARY_DIR}/path.i)

CONFIGURE_FILE(doxy2swig.py  ${CMAKE_CURRENT_BINARY_DIR}/doxy2swig.py COPYONLY)

CONFIGURE_FILE(siconos_pythonpath.in ${CMAKE_CURRENT_BINARY_DIR}/siconos_pythonpath)

INSTALL(PROGRAMS ${CMAKE_CURRENT_SOURCE_DIR}/functions/__init__.py
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos/functions)

INSTALL(PROGRAMS ${CMAKE_CURRENT_SOURCE_DIR}/functions/functions.py
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos/functions)

INSTALL(PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/__init__.py 
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)

INSTALL(FILES ${CMAKE_CURRENT_BINARY_DIR}/siconos_pythonpath DESTINATION
  share/siconos-front-end)

MESSAGE(STATUS "swig modules: ${SWIG_MODULE_Numerics_REAL_NAME},  ${SWIG_MODULE_Kernel_REAL_NAME}")

INSTALL(TARGETS ${SWIG_MODULE_Numerics_REAL_NAME} ${SWIG_MODULE_Kernel_REAL_NAME}
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)

IF(HAVE_SICONOS_IO)
  INSTALL(TARGETS ${SWIG_MODULE_IO_REAL_NAME}
    DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)
ENDIF()

IF(WITH_FCLIB)
  INSTALL(PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/FCLib.py 
    DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)
  INSTALL(TARGETS ${SWIG_MODULE_FCLib_REAL_NAME}
    DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos)
ENDIF()


INSTALL(FILES ${CMAKE_CURRENT_SOURCE_DIR}/KernelTypes.i
	      ${CMAKE_CURRENT_SOURCE_DIR}/Kernel.i
              ${CMAKE_CURRENT_SOURCE_DIR}/IO.i
	      ${CMAKE_CURRENT_SOURCE_DIR}/addons.hpp
  DESTINATION share/siconos-front-end/swig)

#INSTALL(FILES ${CMAKE_CURRENT_SOURCE_DIR}/Siconos/KernelRegistration.i DESTINATION include/Siconos/FrontEnd)
#INSTALL(FILES ${CMAKE_BINARY_DIR}/src/swig/Siconos/Kernel-docstrings.i DESTINATION include/Siconos/FrontEnd)

GET_FILENAME_COMPONENT(SiconosKernel_DIR ${SiconosKernel_EXE_DIR} PATH)
SET(SiconosKernel_XML_SCHEMA "${SiconosKernel_DIR}/share/siconos-kernel")

CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/functions/fromXml.py.in
	${CMAKE_BINARY_DIR}/src/swig/fromXml.py)

INSTALL(PROGRAMS ${CMAKE_CURRENT_SOURCE_DIR}/functions/SiconosXMLParser.py
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos/functions)

INSTALL(PROGRAMS ${CMAKE_BINARY_DIR}/src/swig/fromXml.py
  DESTINATION ${PYTHON_DIST_PACKAGES}/Siconos/functions)


ENABLE_TESTING()

CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/tests/Rover1039.dat Rover1039.dat COPYONLY)
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/tests/SBM1.dat SBM1.dat COPYONLY)
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/tests/smc_2.ref smc_2.ref COPYONLY)
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/tests/result.ref result.ref COPYONLY)
CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/tests/diode_bridge.ref diode_bridge.ref COPYONLY)

FILE(COPY ${CMAKE_CURRENT_SOURCE_DIR}/tests/data DESTINATION
  ${CMAKE_BINARY_DIR}/src/swig/Siconos)

ADD_TEST(lcp ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_lcp.py)
ADD_TEST(mlcp ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_mlcp.py)
ADD_TEST(mcp ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_mcp.py)
ADD_TEST(mcp2 ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_mcp2.py)
ADD_TEST(vi ${PYTHON_EXECUTABLE}  ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_vi.py)
ADD_TEST(sparse ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_sparse.py)
ADD_TEST(Kernel ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_Kernel.py)
ADD_TEST(friction_contact ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_friction_contact.py)
ADD_TEST(bouncing_ball ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_bouncing_ball.py)
ADD_TEST(diode_bridge ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_diode_bridge.py)
ADD_TEST(smc ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_smc.py)
ADD_TEST(matrix_exp ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_matrix_exp.py)
ADD_TEST(xml ${PYTHON_EXECUTABLE} ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_xml.py)

IF(WITH_SERIALIZATION)
  ADD_TEST(serialization ${CMAKE_BINARY_DIR}/src/swig/runtest.py ${DRIVE_LETTER}${CMAKE_CURRENT_SOURCE_DIR}/tests/test_serialization.py)
ENDIF(WITH_SERIALIZATION)

SET_TESTS_PROPERTIES(lcp PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(mlcp PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(mcp PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(sparse PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(Kernel PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(friction_contact PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(bouncing_ball PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(smc PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")
SET_TESTS_PROPERTIES(matrix_exp PROPERTIES FAIL_REGULAR_EXPRESSION "FAILURE;Exception;failed;ERROR;Assertion")

SUBDIRS(tests)

CLOSE_PROJECT()
