#!/bin/sh
# Siconos-Front-End version 2.1.1, Copyright INRIA 2005-2007.
# Siconos is a program dedicated to modeling, simulation and control
# of non smooth dynamical systems.	
# Siconos is a free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# Siconos is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Siconos; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
#
# Contact: Vincent ACARY vincent.acary@inrialpes.fr 
#	

#-----------
# Variables
#-----------

DIR=`pwd`;
SICONOSPATH=@KERNEL_PATH@
NUMERICSPATH=@NUMERICS_PATH@
PYTHONPATH=@PYTHONPATH@

SICONOS_SHAREDPATH=$SICONOSPATH/share/siconos-kernel;
#-----------
# functions
#-----------

function compilePlugins() {
    listdir=`find . -type d`;
    echo "listdir = $listdir";
    for dir in $listdir; do
	cd $dir;
	if test "`ls *Plugin.cpp 2>/dev/null`" != ""; then
	    echo "plugin dans $dir !";      
	    make -f $SICONOS_SHAREDPATH/MakefilePluginSample plugin
	    if test "${LD_LIBRARY_PATH}test" = "test"; then
		export LD_LIBRARY_PATH=$PWD;
	    else
		export LD_LIBRARY_PATH=$PWD:$LD_LIBRARY_PATH; 
	    fi;
	fi;
	cd $DIR;
    done;
    echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH";
}

function cleanAll() {
    listdir=`find . -type d`;
    echo "listdir = $listdir";
    for dir in $listdir; do
	cd $dir;
	make -f $SICONOS_SHAREDPATH/MakefilePluginSample clean	    
	cd $DIR;
    done;
}

function cartridge() {
    echo "";
    echo "+-------------- SICONOS --------------+";
    echo "|                                     |";
    echo "|          (c) INRIA CNRS             |";
    echo "|                                     |";
    echo "+-------------------------------------+"; 
    echo "";
}

#------
# main
#------

cartridge;
# parameters and paths
echo "SICONOSPATH= $SICONOSPATH"
export SICONOSPATH=$SICONOSPATH;
if test "$SICONOSPATH" = ""; then
    echo "SICONOSPATH undefined. stop";
    exit 1;
fi;

echo "NUMERICSPATH= $NUMERICSPATH"
export NUMERICSPATH=$NUMERICSPATH;
if test "$NUMERICSPATH" = ""; then
    echo "NUMERICSPATH undefined. stop";
    exit 1;
fi;

if test "${LD_LIBRARY_PATH}test" = "test"; then
   export LD_LIBRARY_PATH=$SICONOSPATH/lib:$SICONOS_SHAREDPATH:$NUMERICSPATH/lib:/usr/local/lib;  
else
   export LD_LIBRARY_PATH=$SICONOSPATH/lib:$SICONOS_SHAREDPATH:$NUMERICSPATH/lib:/usr/local/lib:$LD_LIBRARY_PATH; 
fi;	 

if test "${PYTHONPATH}test" = "test"; then
   export PYTHONPATH=$SICONOSPATH/site-package;  
else
   export PYTHONPATH=$SICONOSPATH/site-package:$PYTHONPATH; 
fi;	 

clean="false";
while getopts ch OPTION
  do
  case "$OPTION" in
      c) clean=true;;
      h) echo "Path to a sample source file : compiles, links and runs this sample";
	 echo "-c : cleans the current repertory (deletes binary files, etc.)";
	 echo "-h : prints this help and exits";
	 exit 0;
	 ;;
  esac
done
echo "$# $0 $1 $2"

if "$clean" = "true"; then
    if [ $# -eq 2 ]; then
	if [ ! -d $2 ]; then
	    echo "$2 no such file or directory.";
	    exit 1;
	else
	    echo "OK";
	    cd $2;
	    cleanAll;
	    cd ..;
	    exit 0;
	fi;	    
    else	
	cleanAll;
	exit 0;
    fi;
fi;


# plugin compilation
compilePlugins;

# Execution 
python -i $1


